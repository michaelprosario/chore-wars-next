@using ChoreWars.Core.Interfaces
@{
    ViewData["Title"] = "Quest Board";
    var user = ViewBag.User as ChoreWars.Core.Entities.User;
    var availableQuests = ViewBag.AvailableQuests as List<QuestDto> ?? new List<QuestDto>();
    var activeQuests = ViewBag.ActiveQuests as List<QuestDto> ?? new List<QuestDto>();
}

<div class="container mt-4">
    <h1 class="mb-4">‚öîÔ∏è Quest Board</h1>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Player Stats Section -->
    @if (user != null)
    {
        <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body">
                <h5 class="card-title">üë§ @user.DisplayName - Level @user.CurrentLevel</h5>
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-warning" role="progressbar"
                         style="width: @((double)user.CurrentXP / user.XPToNextLevel * 100)%"
                         aria-valuenow="@user.CurrentXP" aria-valuemin="0" aria-valuemax="@user.XPToNextLevel">
                        @user.CurrentXP / @user.XPToNextLevel XP
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col">
                        <strong>üí∞ Gold</strong><br />
                        @user.TotalGold
                    </div>
                    <div class="col">
                        <strong>üí™ STR</strong><br />
                        @user.Strength
                    </div>
                    <div class="col">
                        <strong>üß† INT</strong><br />
                        @user.Intelligence
                    </div>
                    <div class="col">
                        <strong>‚ù§Ô∏è CON</strong><br />
                        @user.Constitution
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Active Quests Section -->
    <div class="mb-5">
        <h2 class="mb-3">üìã My Active Quests</h2>
        @if (activeQuests.Count == 0)
        {
            <div class="alert alert-info">
                You have no active quests. Claim a quest below to get started!
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var quest in activeQuests)
                {
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <strong>@quest.Title</strong>
                                <span class="badge bg-light text-dark float-end">@quest.Difficulty</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text">@quest.Description</p>
                                <hr />
                                <div class="row text-center">
                                    <div class="col">
                                        <small>XP</small><br />
                                        <strong>@quest.XPReward</strong>
                                    </div>
                                    <div class="col">
                                        <small>Gold</small><br />
                                        <strong>üí∞ @quest.GoldReward</strong>
                                    </div>
                                </div>
                                @if (quest.StrengthBonus > 0 || quest.IntelligenceBonus > 0 || quest.ConstitutionBonus > 0)
                                {
                                    <hr />
                                    <div class="text-center">
                                        <small>Stat Bonuses:</small><br />
                                        @if (quest.StrengthBonus > 0) { <span class="badge bg-danger">üí™ +@quest.StrengthBonus</span> }
                                        @if (quest.IntelligenceBonus > 0) { <span class="badge bg-info">üß† +@quest.IntelligenceBonus</span> }
                                        @if (quest.ConstitutionBonus > 0) { <span class="badge bg-success">‚ù§Ô∏è +@quest.ConstitutionBonus</span> }
                                    </div>
                                }
                            </div>
                            <div class="card-footer">
                                @if (quest.CompletionStatus == "Claimed")
                                {
                                    <div class="d-grid gap-2">
                                        <form asp-action="Complete" asp-route-questCompletionId="@quest.CompletionId" method="post">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-success w-100">‚úì Mark Complete</button>
                                        </form>
                                        <button type="button" class="btn btn-outline-danger w-100"
                                                data-bs-toggle="modal"
                                                data-bs-target="#unclaimModal-@quest.CompletionId">
                                            ‚úó Unclaim Quest
                                        </button>
                                    </div>
                                }
                                else if (quest.CompletionStatus == "PendingVerification")
                                {
                                    <div class="alert alert-info mb-0">
                                        ‚è≥ Awaiting DM Verification
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Unclaim Confirmation Modal -->
                    <div class="modal fade" id="unclaimModal-@quest.CompletionId" tabindex="-1"
                         aria-labelledby="unclaimModalLabel-@quest.CompletionId" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="unclaimModalLabel-@quest.CompletionId">Unclaim Quest?</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to unclaim "<strong>@quest.Title</strong>"?
                                    <br /><br />
                                    This will return the quest to the available quests pool and allow others to claim it.
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <form asp-action="Unclaim" asp-route-questCompletionId="@quest.CompletionId"
                                          method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-danger">Unclaim</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Available Quests Section -->
    <div class="mb-5">
        <h2 class="mb-3">üéØ Available Quests</h2>
        @if (availableQuests.Count == 0)
        {
            <div class="alert alert-warning">
                No quests available at the moment. Check back later!
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var quest in availableQuests)
                {
                    var difficultyClass = quest.Difficulty switch
                    {
                        "Easy" => "success",
                        "Medium" => "warning",
                        "Hard" => "danger",
                        _ => "secondary"
                    };

                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-@difficultyClass text-white">
                                <strong>@quest.Title</strong>
                                <span class="badge bg-light text-dark float-end">@quest.QuestType</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text">@quest.Description</p>
                                <hr />
                                <div class="row text-center">
                                    <div class="col">
                                        <small>XP</small><br />
                                        <strong>@quest.XPReward</strong>
                                    </div>
                                    <div class="col">
                                        <small>Gold</small><br />
                                        <strong>üí∞ @quest.GoldReward</strong>
                                    </div>
                                </div>
                                @if (quest.StrengthBonus > 0 || quest.IntelligenceBonus > 0 || quest.ConstitutionBonus > 0)
                                {
                                    <hr />
                                    <div class="text-center">
                                        <small>Stat Bonuses:</small><br />
                                        @if (quest.StrengthBonus > 0) { <span class="badge bg-danger">üí™ +@quest.StrengthBonus</span> }
                                        @if (quest.IntelligenceBonus > 0) { <span class="badge bg-info">üß† +@quest.IntelligenceBonus</span> }
                                        @if (quest.ConstitutionBonus > 0) { <span class="badge bg-success">‚ù§Ô∏è +@quest.ConstitutionBonus</span> }
                                    </div>
                                }
                            </div>
                            <div class="card-footer">
                                <form asp-action="Claim" asp-route-questId="@quest.Id" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-primary w-100">‚öîÔ∏è Claim Quest</button>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>
